---
- block:
    ########################################################################
    # 1. Basic system setup: update & upgrade packages, install htop, etc.   #
    ########################################################################
    - name: Update apt cache
      ansible.builtin.apt:
        update_cache: yes

    - name: Upgrade apt packages
      ansible.builtin.apt:
        upgrade: dist
        autoremove: yes

    - name: Install htop
      ansible.builtin.apt:
        name: htop
        state: present

    ########################################################################
    # 2. Configure SSH and change the port                                   #
    ########################################################################
    - name: Disable password authentication in SSH
      ansible.builtin.lineinfile:
        path: /etc/ssh/sshd_config
        regexp: '^#?PasswordAuthentication '
        line: 'PasswordAuthentication no'
        backup: yes

    - name: Ensure PermitRootLogin is set to yes
      ansible.builtin.lineinfile:
        path: /etc/ssh/sshd_config
        regexp: '^#?PermitRootLogin '
        line: 'PermitRootLogin yes'

    - name: Ensure PubkeyAuthentication is set to yes
      ansible.builtin.lineinfile:
        path: /etc/ssh/sshd_config
        regexp: '^#?PubkeyAuthentication '
        line: 'PubkeyAuthentication yes'

    - name: Change SSH port to 65456
      ansible.builtin.lineinfile:
        path: /etc/ssh/sshd_config
        regexp: '^#?Port '
        line: 'Port 65456'

    - name: Restart SSH service
      ansible.builtin.service:
        name: ssh
        state: restarted

  become: true

################################################################################
# 3. Backup your inventory file (do once only, typically on localhost).        #
################################################################################
- name: Backup inventory file
  ansible.builtin.copy:
    src: "{{ playbook_dir }}/inventory/hosts.yml"
    dest: "{{ playbook_dir }}/inventory/hosts.yml.backup"
  delegate_to: localhost
  run_once: true

########################################################################
# 4. Copy your SSH public key and test key-based login                   #
########################################################################
- name: Ensure /root/.ssh directory exists
  ansible.builtin.file:
    path: /root/.ssh
    state: directory
    owner: root
    group: root
    mode: '0700'
  become: true

- name: Copy authorized_keys for root
  ansible.builtin.copy:
    src: authorized_keys
    dest: /root/.ssh/authorized_keys
    owner: root
    group: root
    mode: '0600'
    backup: yes
  become: true

#######################################################################
# 5. Test SSH key access from your control machine to the remote host   #
#######################################################################
- name: Test SSH key access
  ansible.builtin.shell: >
    ssh -i {{ playbook_dir }}/files/id_rsa
    -o PasswordAuthentication=no
    -o PubkeyAuthentication=yes
    -o StrictHostKeyChecking=no
    -p 65456
    root@{{ ansible_host }}
    "echo success"
  register: ssh_test
  ignore_errors: yes
  delegate_to: localhost

################################################################################
# 6. Update inventory with new configuration if SSH test succeeds              #
################################################################################
- name: Update inventory file with new configuration
  ansible.builtin.blockinfile:
    path: "{{ playbook_dir }}/inventory/hosts.yml"
    insertafter: "all:"
    block: |
      hosts:
        new_{{ inventory_hostname }}:
          ansible_host: {{ ansible_host }}
          ansible_port: 65456
          ansible_user: root
          ansible_ssh_private_key_file: {{ ansible_ssh_private_key_file | default('/path/to/your/private_key') }}
  delegate_to: localhost
  when: ssh_test.rc == 0

################################################################################
# 7. Reboot the server if all tests passed successfully                        #
################################################################################
- name: Reboot the server
  ansible.builtin.reboot:
    msg: "Rebooting server after successful configuration"
    connect_timeout: 5
    reboot_timeout: 300
    pre_reboot_delay: 0
    post_reboot_delay: 30
  become: true
  when: ssh_test.rc == 0

vars:
  ssh_port: 65456
  user: root
